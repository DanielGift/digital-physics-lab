<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gradient Descent Explorer</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a27;
    --border: #2a2a3d;
    --text: #e8e8f0;
    --text-dim: #7a7a95;
    --accent: #6366f1;
    --accent-glow: rgba(99, 102, 241, 0.3);
    --green: #22c55e;
    --green-glow: rgba(34, 197, 94, 0.2);
    --red: #ef4444;
    --orange: #f59e0b;
    --cyan: #06b6d4;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .grain {
    position: fixed; inset: 0; z-index: 0; pointer-events: none; opacity: 0.03;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
    background-size: 128px;
  }

  .app {
    position: relative; z-index: 1;
    max-width: 1100px; margin: 0 auto;
    padding: 40px 24px;
  }

  header {
    text-align: center; margin-bottom: 48px;
  }

  header h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2rem; font-weight: 700;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #6366f1, #06b6d4);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 8px;
  }

  header p {
    color: var(--text-dim); font-size: 0.95rem; max-width: 560px; margin: 0 auto;
    line-height: 1.6;
  }

  .layout {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 800px) {
    .layout { grid-template-columns: 1fr; }
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
  }

  .cost-display {
    text-align: center; margin-bottom: 24px;
    padding: 32px 28px;
    position: relative;
    overflow: hidden;
  }

  .cost-display::before {
    content: '';
    position: absolute; inset: 0;
    background: radial-gradient(ellipse at center, var(--accent-glow), transparent 70%);
    opacity: 0.4;
    transition: opacity 0.5s;
  }

  .cost-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem; font-weight: 500;
    text-transform: uppercase; letter-spacing: 3px;
    color: var(--text-dim); margin-bottom: 12px;
    position: relative;
  }

  .cost-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 3.5rem; font-weight: 700;
    position: relative;
    transition: color 0.3s;
  }

  .cost-delta {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem; margin-top: 8px;
    position: relative; min-height: 1.2em;
    transition: color 0.3s;
  }

  .cost-delta.down { color: var(--green); }
  .cost-delta.up { color: var(--red); }
  .cost-delta.same { color: var(--text-dim); }

  .sliders-section { padding: 28px; }

  .slider-group {
    margin-bottom: 28px;
  }
  .slider-group:last-child { margin-bottom: 0; }

  .slider-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 14px;
  }

  .slider-name {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600; font-size: 1rem;
  }

  .slider-name .var-label { color: var(--cyan); }

  .slider-val {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.95rem; color: var(--accent);
    background: rgba(99, 102, 241, 0.1);
    padding: 3px 10px; border-radius: 6px;
  }

  .slider-controls {
    display: flex; align-items: center; gap: 12px;
  }

  .step-btn {
    width: 48px; height: 48px;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    border-radius: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.3rem; font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }

  .step-btn:hover {
    background: var(--accent);
    border-color: var(--accent);
    box-shadow: 0 0 20px var(--accent-glow);
  }

  .step-btn:active {
    transform: scale(0.93);
  }

  .track-container {
    flex: 1; position: relative; height: 48px;
    display: flex; align-items: center;
  }

  .track {
    width: 100%; height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    position: relative;
    overflow: visible;
  }

  .track-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--cyan));
    border-radius: 3px;
    transition: width 0.25s ease;
  }

  .track-thumb {
    position: absolute; top: 50%;
    width: 16px; height: 16px;
    background: var(--text);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: left 0.25s ease;
    box-shadow: 0 0 10px rgba(255,255,255,0.2);
    pointer-events: none;
  }

  .track-optimal {
    position: absolute; top: 50%;
    width: 3px; height: 20px;
    background: var(--green);
    transform: translate(-50%, -50%);
    border-radius: 2px;
    pointer-events: none;
    box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    display: none;
  }

  .track-optimal::after {
    content: '';
    position: absolute;
    top: -4px; left: 50%;
    transform: translateX(-50%);
    width: 9px; height: 9px;
    background: var(--green);
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(34, 197, 94, 0.6);
  }

  .teacher-active .track-optimal {
    display: block;
  }

  /* Sidebar */
  .sidebar { display: flex; flex-direction: column; gap: 20px; }
  .sidebar .card { padding: 24px; }

  .param-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem; font-weight: 500;
    letter-spacing: 2.5px;
    color: var(--text-dim); margin-bottom: 14px;
  }

  .lambda-display {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2rem; font-weight: 700;
    color: var(--orange);
    margin-bottom: 16px;
  }

  .lambda-options {
    display: flex; gap: 8px;
  }

  .lambda-btn {
    flex: 1;
    padding: 10px 0;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text-dim);
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem; font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .lambda-btn:hover {
    border-color: var(--orange);
    color: var(--orange);
  }

  .lambda-btn.active {
    background: var(--orange);
    border-color: var(--orange);
    color: var(--bg);
    box-shadow: 0 0 16px rgba(245, 158, 11, 0.3);
  }

  .steps-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem; color: var(--text-dim);
    margin-top: 4px;
  }

  .steps-count span { color: var(--text); font-weight: 600; }

  .btn-reset {
    width: 100%; padding: 12px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
    border-radius: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem; font-weight: 500;
    letter-spacing: 1px; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s;
  }

  .btn-reset:hover {
    border-color: var(--red); color: var(--red);
    background: rgba(239, 68, 68, 0.05);
  }

  .btn-new {
    width: 100%; padding: 12px;
    background: linear-gradient(135deg, var(--accent), #8b5cf6);
    border: none; color: white;
    border-radius: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem; font-weight: 500;
    letter-spacing: 1px; text-transform: uppercase;
    cursor: pointer; transition: all 0.2s;
  }

  .btn-new:hover {
    box-shadow: 0 0 24px var(--accent-glow);
    transform: translateY(-1px);
  }

  .history-section { margin-top: 0; }

  .history-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem; font-weight: 500;
    text-transform: uppercase; letter-spacing: 2.5px;
    color: var(--text-dim); margin-bottom: 12px;
  }

  .history-list {
    max-height: 180px; overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }

  .history-list::-webkit-scrollbar { width: 4px; }
  .history-list::-webkit-scrollbar-track { background: transparent; }
  .history-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .history-entry {
    display: flex; justify-content: space-between;
    padding: 5px 0; border-bottom: 1px solid rgba(42,42,61,0.4);
    color: var(--text-dim);
  }

  .history-entry .h-cost { color: var(--text); }
  .history-entry .h-delta.down { color: var(--green); }
  .history-entry .h-delta.up { color: var(--red); }

  .best-banner {
    text-align: center; padding: 14px;
    background: linear-gradient(135deg, rgba(34,197,94,0.08), rgba(6,182,212,0.08));
    border: 1px solid rgba(34,197,94,0.2);
    border-radius: 10px;
  }

  .best-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem; text-transform: uppercase;
    letter-spacing: 2px; color: var(--green); margin-bottom: 4px;
  }

  .best-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.4rem; font-weight: 700; color: var(--green);
  }

  .hint-box {
    background: rgba(99, 102, 241, 0.05);
    border: 1px solid rgba(99, 102, 241, 0.15);
    border-radius: 10px; padding: 16px;
    font-size: 0.82rem; color: var(--text-dim); line-height: 1.55;
  }

  .hint-box strong { color: var(--accent); font-weight: 600; }

  /* Teacher view */
  .teacher-toggle {
    display: flex; align-items: center; gap: 10px;
    cursor: pointer; user-select: none;
  }

  .teacher-toggle input[type="checkbox"] { display: none; }

  .teacher-check {
    width: 20px; height: 20px;
    border: 2px solid var(--border);
    border-radius: 5px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
  }

  .teacher-check svg {
    opacity: 0; transition: opacity 0.15s;
    width: 12px; height: 12px;
  }

  .teacher-toggle input:checked + .teacher-check {
    background: var(--green); border-color: var(--green);
  }

  .teacher-toggle input:checked + .teacher-check svg { opacity: 1; }

  .teacher-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem; font-weight: 500; color: var(--text-dim);
  }

  .teacher-panel {
    display: none; margin-top: 16px; padding: 16px;
    background: rgba(34, 197, 94, 0.05);
    border: 1px solid rgba(34, 197, 94, 0.2);
    border-radius: 10px;
  }

  .teacher-active .teacher-panel { display: block; }

  .teacher-panel-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem; text-transform: uppercase;
    letter-spacing: 2px; color: var(--green); margin-bottom: 10px;
  }

  .teacher-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 4px 0;
    font-family: 'JetBrains Mono', monospace; font-size: 0.82rem;
  }

  .teacher-row .t-label { color: var(--text-dim); }
  .teacher-row .t-val { color: var(--green); font-weight: 600; }

  .teacher-distance {
    margin-top: 10px; padding-top: 10px;
    border-top: 1px solid rgba(34, 197, 94, 0.15);
  }

  .teacher-distance .t-label { color: var(--orange); }
  .teacher-distance .t-val { color: var(--orange); }

  /* Password modal */
  .modal-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
  }

  .modal-overlay.visible {
    display: flex;
  }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 340px;
    animation: fadeIn 0.2s ease;
  }

  .modal-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.95rem; font-weight: 600;
    margin-bottom: 6px;
  }

  .modal-subtitle {
    font-size: 0.82rem; color: var(--text-dim);
    margin-bottom: 20px;
  }

  .modal-input {
    width: 100%;
    padding: 12px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .modal-input:focus {
    border-color: var(--accent);
  }

  .modal-input.error {
    border-color: var(--red);
    animation: shake 0.3s ease;
  }

  .modal-error {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--red);
    margin-top: 8px;
    min-height: 1.2em;
  }

  .modal-buttons {
    display: flex; gap: 10px; margin-top: 18px;
  }

  .modal-btn {
    flex: 1; padding: 10px;
    border-radius: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem; font-weight: 500;
    cursor: pointer; transition: all 0.15s;
    letter-spacing: 0.5px;
  }

  .modal-btn-cancel {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-dim);
  }

  .modal-btn-cancel:hover {
    border-color: var(--text-dim);
    color: var(--text);
  }

  .modal-btn-submit {
    background: var(--green);
    border: none;
    color: var(--bg);
    font-weight: 600;
  }

  .modal-btn-submit:hover {
    box-shadow: 0 0 16px var(--green-glow);
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    50% { transform: translateX(6px); }
    75% { transform: translateX(-4px); }
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .card { animation: fadeIn 0.5s ease both; }
  .card:nth-child(1) { animation-delay: 0.05s; }
  .card:nth-child(2) { animation-delay: 0.1s; }
  .card:nth-child(3) { animation-delay: 0.15s; }

  .cost-flash { animation: flash 0.3s ease; }

  @keyframes flash {
    0% { transform: scale(1); }
    50% { transform: scale(1.04); }
    100% { transform: scale(1); }
  }
</style>
</head>
<body>
<div class="grain"></div>
<div class="app">
  <header>
    <h1>Gradient Descent Explorer</h1>
    <p>Find the minimum cost by adjusting x, y, and z. You can only step left or right — use λ to control your step size.</p>
  </header>

  <div class="layout">
    <div class="main-col">
      <div class="card cost-display">
        <div class="cost-label">Current Cost</div>
        <div class="cost-value" id="costValue">—</div>
        <div class="cost-delta same" id="costDelta">&nbsp;</div>
      </div>

      <div class="card sliders-section" id="slidersSection">
        <div class="slider-group" data-var="x">
          <div class="slider-header">
            <span class="slider-name"><span class="var-label">x</span></span>
            <span class="slider-val" id="xVal">50.00</span>
          </div>
          <div class="slider-controls">
            <button class="step-btn" onclick="step('x', -1)">−</button>
            <div class="track-container">
              <div class="track">
                <div class="track-fill" id="xFill" style="width:50%"></div>
                <div class="track-optimal" id="xOptimal"></div>
              </div>
              <div class="track-thumb" id="xThumb" style="left:50%"></div>
            </div>
            <button class="step-btn" onclick="step('x', 1)">+</button>
          </div>
        </div>

        <div class="slider-group" data-var="y">
          <div class="slider-header">
            <span class="slider-name"><span class="var-label">y</span></span>
            <span class="slider-val" id="yVal">50.00</span>
          </div>
          <div class="slider-controls">
            <button class="step-btn" onclick="step('y', -1)">−</button>
            <div class="track-container">
              <div class="track">
                <div class="track-fill" id="yFill" style="width:50%"></div>
                <div class="track-optimal" id="yOptimal"></div>
              </div>
              <div class="track-thumb" id="yThumb" style="left:50%"></div>
            </div>
            <button class="step-btn" onclick="step('y', 1)">+</button>
          </div>
        </div>

        <div class="slider-group" data-var="z">
          <div class="slider-header">
            <span class="slider-name"><span class="var-label">z</span></span>
            <span class="slider-val" id="zVal">50.00</span>
          </div>
          <div class="slider-controls">
            <button class="step-btn" onclick="step('z', -1)">−</button>
            <div class="track-container">
              <div class="track">
                <div class="track-fill" id="zFill" style="width:50%"></div>
                <div class="track-optimal" id="zOptimal"></div>
              </div>
              <div class="track-thumb" id="zThumb" style="left:50%"></div>
            </div>
            <button class="step-btn" onclick="step('z', 1)">+</button>
          </div>
        </div>
      </div>

      <div class="card history-section">
        <div class="history-title">Step History</div>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <div class="param-title">Step Size (λ)</div>
        <div class="lambda-display" id="lambdaDisplay">5.00</div>
        <div class="lambda-options">
          <button class="lambda-btn" onclick="setLambda(1, this)">1</button>
          <button class="lambda-btn" onclick="setLambda(2, this)">2</button>
          <button class="lambda-btn active" onclick="setLambda(5, this)">5</button>
          <button class="lambda-btn" onclick="setLambda(10, this)">10</button>
        </div>
      </div>

      <div class="card">
        <div class="param-title">Progress</div>
        <div class="steps-count">Steps: <span id="stepsCount">0</span></div>
        <div class="best-banner" style="margin-top: 14px;">
          <div class="best-label">Best Cost Found</div>
          <div class="best-value" id="bestCost">—</div>
        </div>
      </div>

      <div class="card" id="teacherCard">
        <label class="teacher-toggle">
          <input type="checkbox" id="teacherCheck" onchange="toggleTeacher()">
          <span class="teacher-check">
            <svg viewBox="0 0 12 12" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="2,6 5,9 10,3"/>
            </svg>
          </span>
          <span class="teacher-label">Teacher View</span>
        </label>
        <div class="teacher-panel">
          <div class="teacher-panel-title">Global Minimum</div>
          <div class="teacher-row">
            <span class="t-label">x*</span>
            <span class="t-val" id="optX">—</span>
          </div>
          <div class="teacher-row">
            <span class="t-label">y*</span>
            <span class="t-val" id="optY">—</span>
          </div>
          <div class="teacher-row">
            <span class="t-label">z*</span>
            <span class="t-val" id="optZ">—</span>
          </div>
          <div class="teacher-row" style="margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(34,197,94,0.15);">
            <span class="t-label">Min Cost</span>
            <span class="t-val">1.2100</span>
          </div>
          <div class="teacher-row teacher-distance">
            <span class="t-label">Your distance</span>
            <span class="t-val" id="optDist">—</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button class="btn-reset" onclick="resetPosition()">Reset Position</button>
          <button class="btn-new" onclick="newFunction()">New Function</button>
        </div>
      </div>

      <div class="card hint-box">
        The cost function is <strong>hidden</strong>. Try to minimize it using only the step buttons. Experiment with different <strong>λ</strong> values — too large and you'll overshoot, too small and you'll get stuck.<br><br>
        <strong>Keyboard:</strong> A/D = x, W/S = y, Q/E = z
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="passwordModal">
  <div class="modal">
    <div class="modal-title">Teacher View</div>
    <div class="modal-subtitle">Enter the password to unlock.</div>
    <input type="password" class="modal-input" id="passwordInput" placeholder="Password" autocomplete="off">
    <div class="modal-error" id="passwordError">&nbsp;</div>
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn modal-btn-submit" onclick="submitPassword()">Unlock</button>
    </div>
  </div>
</div>

<script>
// --- State ---
let vars = { x: 50, y: 50, z: 50 };
let lambda = 5;
let steps = 0;
let bestCost = Infinity;
let prevCost = null;
let fnParams = null;
let optimalPoint = { x: 50, y: 50, z: 50 };

// --- Generate random multi-extrema function ---
function generateFunction() {
  const rng = () => Math.random();
  const ri = (lo, hi) => lo + rng() * (hi - lo);

  // Generate 5-8 gaussian bumps
  const numBumps = 5 + Math.floor(rng() * 4);
  const bumps = [];
  for (let i = 0; i < numBumps; i++) {
    bumps.push({
      cx: ri(10, 90), cy: ri(10, 90), cz: ri(10, 90),
      sx: ri(8, 30), sy: ri(8, 30), sz: ri(8, 30),
      amp: ri(-3, 5),
    });
  }

  // Add sinusoidal waves
  const numWaves = 3 + Math.floor(rng() * 3);
  const waves = [];
  for (let i = 0; i < numWaves; i++) {
    waves.push({
      fx: ri(0.02, 0.12), fy: ri(0.02, 0.12), fz: ri(0.02, 0.12),
      px: ri(0, Math.PI * 2), py: ri(0, Math.PI * 2), pz: ri(0, Math.PI * 2),
      amp: ri(0.5, 2.5),
    });
  }

  function rawF(x, y, z) {
    let val = 0;
    for (const b of bumps) {
      const dx = (x - b.cx) / b.sx;
      const dy = (y - b.cy) / b.sy;
      const dz = (z - b.cz) / b.sz;
      val += b.amp * Math.exp(-(dx*dx + dy*dy + dz*dz));
    }
    for (const w of waves) {
      val += w.amp * Math.sin(w.fx * x + w.px) * Math.sin(w.fy * y + w.py) * Math.sin(w.fz * z + w.pz);
    }
    return val;
  }

  // --- Coarse grid search ---
  let sampleMin = Infinity, sampleMax = -Infinity;
  let bestX = 50, bestY = 50, bestZ = 50;
  const N = 40;
  for (let i = 0; i <= N; i++) {
    for (let j = 0; j <= N; j++) {
      for (let k = 0; k <= N; k++) {
        const x = i * 100 / N, y = j * 100 / N, z = k * 100 / N;
        const v = rawF(x, y, z);
        if (v < sampleMin) { sampleMin = v; bestX = x; bestY = y; bestZ = z; }
        if (v > sampleMax) sampleMax = v;
      }
    }
  }

  // --- Fine-grained local refinement (3 passes) ---
  let refinedMin = sampleMin;
  const coarseStep = 100 / N;
  for (let pass = 0; pass < 4; pass++) {
    const searchRadius = coarseStep / Math.pow(3, pass);
    const subN = 12;
    let lx = bestX, ly = bestY, lz = bestZ;
    for (let i = -subN; i <= subN; i++) {
      for (let j = -subN; j <= subN; j++) {
        for (let k = -subN; k <= subN; k++) {
          const x = Math.max(0, Math.min(100, bestX + i * searchRadius / subN));
          const y = Math.max(0, Math.min(100, bestY + j * searchRadius / subN));
          const z = Math.max(0, Math.min(100, bestZ + k * searchRadius / subN));
          const v = rawF(x, y, z);
          if (v < refinedMin) { refinedMin = v; lx = x; ly = y; lz = z; }
        }
      }
    }
    bestX = lx; bestY = ly; bestZ = lz;
  }
  sampleMin = refinedMin;

  optimalPoint = { x: bestX, y: bestY, z: bestZ };

  const TARGET_MIN = 1.21;
  const TARGET_MAX = TARGET_MIN + ri(40, 120);
  const range = sampleMax - sampleMin || 1;

  fnParams = {
    eval(x, y, z) {
      const raw = rawF(x, y, z);
      const normalized = (raw - sampleMin) / range;
      return TARGET_MIN + normalized * (TARGET_MAX - TARGET_MIN);
    }
  };
}

function computeCost() {
  return fnParams.eval(vars.x, vars.y, vars.z);
}

// --- UI Updates ---
function updateDisplay() {
  const cost = computeCost();

  const costEl = document.getElementById('costValue');
  costEl.textContent = cost.toFixed(4);
  costEl.classList.remove('cost-flash');
  void costEl.offsetWidth;
  costEl.classList.add('cost-flash');

  const deltaEl = document.getElementById('costDelta');
  if (prevCost !== null) {
    const diff = cost - prevCost;
    if (Math.abs(diff) < 0.00005) {
      deltaEl.textContent = '\u2192 0.0000';
      deltaEl.className = 'cost-delta same';
    } else if (diff < 0) {
      deltaEl.textContent = '\u25BC ' + Math.abs(diff).toFixed(4);
      deltaEl.className = 'cost-delta down';
    } else {
      deltaEl.textContent = '\u25B2 ' + diff.toFixed(4);
      deltaEl.className = 'cost-delta up';
    }
  } else {
    deltaEl.innerHTML = '&nbsp;';
    deltaEl.className = 'cost-delta same';
  }

  const glowIntensity = Math.max(0, 1 - (cost - 1.21) / 30);
  document.querySelector('.cost-display').style.setProperty('--accent-glow',
    'rgba(34, 197, 94, ' + (0.1 + glowIntensity * 0.4) + ')');

  if (cost < bestCost) bestCost = cost;
  document.getElementById('bestCost').textContent = bestCost.toFixed(4);
  document.getElementById('stepsCount').textContent = steps;

  for (const v of ['x', 'y', 'z']) {
    const pct = vars[v];
    document.getElementById(v + 'Val').textContent = vars[v].toFixed(2);
    document.getElementById(v + 'Fill').style.width = pct + '%';
    document.getElementById(v + 'Thumb').style.left = pct + '%';
  }

  updateTeacherView();
}

function updateTeacherView() {
  document.getElementById('optX').textContent = optimalPoint.x.toFixed(2);
  document.getElementById('optY').textContent = optimalPoint.y.toFixed(2);
  document.getElementById('optZ').textContent = optimalPoint.z.toFixed(2);

  const dx = vars.x - optimalPoint.x;
  const dy = vars.y - optimalPoint.y;
  const dz = vars.z - optimalPoint.z;
  const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
  document.getElementById('optDist').textContent = dist.toFixed(2);

  document.getElementById('xOptimal').style.left = optimalPoint.x + '%';
  document.getElementById('yOptimal').style.left = optimalPoint.y + '%';
  document.getElementById('zOptimal').style.left = optimalPoint.z + '%';
}

let teacherUnlocked = false;

function toggleTeacher() {
  const checkbox = document.getElementById('teacherCheck');
  if (checkbox.checked && !teacherUnlocked) {
    // Revert the check and show password modal
    checkbox.checked = false;
    showModal();
    return;
  }
  applyTeacherView(checkbox.checked);
}

function applyTeacherView(active) {
  const section = document.getElementById('slidersSection');
  const card = document.getElementById('teacherCard');
  if (active) {
    section.classList.add('teacher-active');
    card.classList.add('teacher-active');
  } else {
    section.classList.remove('teacher-active');
    card.classList.remove('teacher-active');
  }
}

function showModal() {
  const modal = document.getElementById('passwordModal');
  const input = document.getElementById('passwordInput');
  const error = document.getElementById('passwordError');
  modal.classList.add('visible');
  input.value = '';
  input.classList.remove('error');
  error.innerHTML = '&nbsp;';
  setTimeout(() => input.focus(), 50);
}

function closeModal() {
  document.getElementById('passwordModal').classList.remove('visible');
}

function submitPassword() {
  const input = document.getElementById('passwordInput');
  const error = document.getElementById('passwordError');
  if (input.value === 'thisisthepassword') {
    teacherUnlocked = true;
    closeModal();
    const checkbox = document.getElementById('teacherCheck');
    checkbox.checked = true;
    applyTeacherView(true);
  } else {
    input.classList.add('error');
    error.textContent = 'Incorrect password';
    setTimeout(() => input.classList.remove('error'), 300);
  }
}

// Enter key in modal
document.getElementById('passwordInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitPassword();
  if (e.key === 'Escape') closeModal();
});

// Close modal on overlay click
document.getElementById('passwordModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

function addHistoryEntry(varName, dir, oldCost, newCost) {
  const diff = newCost - oldCost;
  const entry = document.createElement('div');
  entry.className = 'history-entry';
  const arrow = dir > 0 ? '+' : '\u2212';
  const deltaClass = diff < -0.00005 ? 'down' : diff > 0.00005 ? 'up' : '';
  const deltaSign = diff < 0 ? '\u25BC' : diff > 0 ? '\u25B2' : '\u2192';
  entry.innerHTML =
    '<span>' + varName + ' ' + arrow + lambda.toFixed(1) + '</span>' +
    '<span class="h-cost">' + newCost.toFixed(4) + '</span>' +
    '<span class="h-delta ' + deltaClass + '">' + deltaSign + Math.abs(diff).toFixed(2) + '</span>';
  const list = document.getElementById('historyList');
  list.prepend(entry);
  if (list.children.length > 100) list.removeChild(list.lastChild);
}

// --- Actions ---
function step(varName, direction) {
  const oldCost = computeCost();
  prevCost = oldCost;
  vars[varName] = Math.max(0, Math.min(100, vars[varName] + direction * lambda));
  steps++;
  const newCost = computeCost();
  addHistoryEntry(varName, direction, oldCost, newCost);
  updateDisplay();
}

function resetPosition() {
  vars = { x: 50, y: 50, z: 50 };
  steps = 0;
  bestCost = Infinity;
  prevCost = null;
  document.getElementById('historyList').innerHTML = '';
  updateDisplay();
}

function newFunction() {
  generateFunction();
  resetPosition();
}

// Lambda buttons
function setLambda(val, btn) {
  lambda = val;
  document.getElementById('lambdaDisplay').textContent = val.toFixed(2);
  document.querySelectorAll('.lambda-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT') return;
  const key = e.key.toLowerCase();
  if (key === 'a') step('x', -1);
  else if (key === 'd') step('x', 1);
  else if (key === 'w') step('y', 1);
  else if (key === 's') step('y', -1);
  else if (key === 'q') step('z', -1);
  else if (key === 'e') step('z', 1);
});

// --- Init ---
generateFunction();
updateDisplay();
</script>
</body>
</html>
